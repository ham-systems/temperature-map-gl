//! temperature-map-gl.js
//! version : 0.5.0
//! authors : Lefteris Chatzipetrou
//! license : MIT
//! http://chpetrou.net
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.temperature_map_gl=i()}(this,function(){"use strict";function t(t,i,e){if("fragment"==e)e=t.FRAGMENT_SHADER;else{if("vertex"!=e)return null;e=t.VERTEX_SHADER}var r=t.createShader(e);return(t.shaderSource(r,i),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS))?r:(logger.info("An error occurred compiling the shaders: "+t.getShaderInfoLog(r)),t.deleteShader(r),null)}function i(t,i,e){var r=t.createProgram();return t.attachShader(r,i),t.attachShader(r,e),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS)||logger.info("Unable to initialize the shader program: "+t.getProgramInfoLog(r)),r}var e={p:1,canvas:null,opacity:.85,range_factor:.00390625,gamma:1,show_points:!1,framebuffer_factor:1,image_zindex:0,dist_factor:1,unit:"\xb0C",id:"",point_text:function(t){var i;return 1>Math.abs(t)?t.toFixed(2):10>Math.abs(t)?t.toFixed(1):Math.round(t)},color_map:[[-50,"#cbecff"],[-40,"#8998c7"],[-32,"#875aa7"],[-25,"#821d7c"],[-18,"#002258"],[-14,"#193b95"],[-10,"#124c9f"],[-6,"#0a60a8"],[-2,"#0078b5"],[2,"#33b6c6"],[6,"#5ac8c6"],[10,"#96dba6"],[14,"#76db8e"],[18,"#5ddb7a"],[22,"#4cdb6d"],[24,"#8bdb4c"],[26,"#bedb4c"],[28,"#eed371"],[30,"#eec42b"],[32,"#eea02b"],[35,"#ee810f"],[38,"#ee590f"],[40,"#ff3c1a"],[43,"#ff3800"],[47,"#ff1700"],[50,"#db0000"],[55,"#ad0000"],[60,"#6c0000"],[70,"#380000"],[80,"#1c0000"],[90,"#8700ff"],[100,"#ff00ed"],]},r=0;function o(t,i){var o={};for(var a in e)o[a]=e[a];if("object"==typeof i)for(var a in i)o[a]=i[a];this.instance=r++,this.image_element=t,t.style.zIndex=o.image_zindex;var n=o.canvas||document.createElement("canvas");n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.style.zIndex=t.style.zIndex?""+(Number(t.style.zIndex)+1):"10",n.style.opacity=o.opacity,n.style.pointerEvents="none",n.id=o.id,o.canvas?this.own_canvas=!1:(t.parentNode.insertBefore(n,t.nextSibling),this.own_canvas=!0),this.canvas=n,this.context=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),this.context||logger.info("Your browser does not support webgl"),this.context&&this.context.getExtension("OES_texture_half_float")||(logger.info("Your browser does not support float textures"),this.context=null),this.ext=this.context?this.context.getExtension("OES_texture_half_float"):{},this.color_map=o.color_map,this.color_map_texture=this.generate_color_map_texture(this.color_map),this.points=[],this.translated_points=[],this.square_vertices_buffer=null,this.computation_program=null,this.draw_program=null,this.position_attribute=null,this.computation_framebuffer=null,this.computation_texture=null,this.ui_uniform=null,this.xi_uniform=null,this.c_screen_size_uniform=null,this.d_screen_size_uniform=null,this.range_factor_uniform=null,this.dist_factor_uniform=null,this.p_uniform=null,this.computation_texture_uniform=null,this.gamma_uniform=null,this.color_map_uniform=null,this.point_text=o.point_text,this.p=o.p,this.range_factor=o.range_factor,this.dist_factor=o.dist_factor,this.gamma=o.gamma,this.show_points=o.show_points,this.unit=o.unit,this.framebuffer_factor=o.framebuffer_factor,this.computation_framebuffer_width=0,this.computation_framebuffer_height=0,this.init_shaders(),this.resize(this.image_element.clientWidth,this.image_element.clientHeight)}function a(t,i){for(var e=0;e<i.length;++e){var r=Number(i[e][0]),o=i[e][1];if(t<=r)return o}return i[i.length-1][1]}function n(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,i,e,r){return i+i+e+e+r+r});var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}return o.prototype.update_options=function(t){t.p&&(this.p=t.p),t.range_factor&&(this.range_factor=t.range_factor),t.dist_factor&&(this.dist_factor=t.dist_factor),void 0!==t.unit&&(this.unit=t.unit),t.gamma&&(this.gamma=t.gamma),t.show_points&&(this.show_points=t.show_points),t.color_map&&(this.context.deleteTexture(this.color_map_texture),this.color_map=t.color_map,this.color_map_texture=this.generate_color_map_texture(this.color_map)),this.draw()},o.is_supported=function(){var t=document.createElement("canvas"),i=t.getContext("webgl");return t&&i&&i.getExtension("OES_texture_half_float")},o.prototype.set_points=function(t,i,e,r){if(this.points=t,this.context){var o=[];if(t.length){for(var a=void 0!==i?Math.min(t[0][2],i):t[0][2],n=void 0!==e?Math.max(t[0][2],e):t[0][2],s=void 0!==r?r:0,f=1;f<t.length;++f){var h=[t[f][0],t[f][1],t[f][2]];h[2]>n&&(n=h[2]),h[2]<a&&(a=h[2]),void 0===r&&(s+=h[2]/t.length)}for(var c=n>a?n-a:1,u=this.canvas.width,m=this.canvas.height,f=0;f<t.length;++f){var h=[t[f][0],t[f][1],t[f][2]];h[0]=h[0]/u,h[1]=h[1]/m,void 0!==i&&void 0!==e&&void 0!==r?h[2]=Math.max(Math.min(1,Math.pow((2*h[2]-i-r)/(e-i),1)),0):void 0!==i&&void 0!==e?h[2]=Math.max(Math.min(1,Math.pow((h[2]-i)/(e-i),1)),0):h[2]=Math.max(Math.min(1,Math.pow((2*h[2]-s-a)/c,1)+.5),0),o.push(h)}}this.translated_points=o}},o.prototype.init_buffers=function(){if(this.context){var t=this.context;this.square_vertices_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.square_vertices_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),t.STATIC_DRAW),this.computation_framebuffer_width=Math.ceil(this.canvas.width*this.framebuffer_factor),this.computation_framebuffer_height=Math.ceil(this.canvas.height*this.framebuffer_factor),this.computation_texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.computation_texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.computation_framebuffer_width,this.computation_framebuffer_height,0,t.RGBA,this.ext.HALF_FLOAT_OES,null),this.computation_framebuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.computation_framebuffer),t.viewport(0,0,this.computation_framebuffer_width,this.computation_framebuffer_height),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.computation_texture,0),t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer(t.FRAMEBUFFER,null)}},o.prototype.init_shaders=function(){if(this.context){var e=this.context,r=t(e,"		attribute vec2 position;																																						void main(void) {																			gl_Position = vec4(position.x*2.0-1.0, position.y*2.0-1.0, 1.0, 1.0);				}																					","vertex"),o=t(e,"		precision highp float;																																							uniform float ui;																		uniform vec2 xi;																		uniform float p;																		uniform float dist_factor;																uniform float range_factor;																uniform vec2 screen_size;																void main(void) {																			vec2 x = vec2(gl_FragCoord.x/screen_size.x, gl_FragCoord.y/screen_size.y);				float dist = distance(x, xi)/dist_factor;												float wi = 1.0/pow(dist, p);															gl_FragColor = vec4(ui*wi*range_factor, wi*range_factor, 0.0, 1.0);					}																					","fragment"),a=t(e,"		precision highp float;																																																																					uniform sampler2D color_map;																															uniform sampler2D computation_texture;																												uniform vec2 screen_size;																															uniform float gamma;																																void main(void) {																																		vec4 data = texture2D(computation_texture, vec2(gl_FragCoord.x/screen_size.x, 1.0-gl_FragCoord.y/screen_size.y));									float val = data.x/data.y;																															vec4 color = texture2D(color_map, vec2(val, 0.5));			gl_FragColor.rgba = pow(color, vec4(1.0/gamma));																									}																																				","fragment");this.computation_program=i(e,r,o),this.position_attribute=e.getAttribLocation(this.computation_program,"position"),this.ui_uniform=e.getUniformLocation(this.computation_program,"ui"),this.xi_uniform=e.getUniformLocation(this.computation_program,"xi"),this.c_screen_size_uniform=e.getUniformLocation(this.computation_program,"screen_size"),this.range_factor_uniform=e.getUniformLocation(this.computation_program,"range_factor"),this.dist_factor_uniform=e.getUniformLocation(this.computation_program,"dist_factor"),this.p_uniform=e.getUniformLocation(this.computation_program,"p"),e.enableVertexAttribArray(this.position_attribute),this.draw_program=i(e,r,a),this.d_screen_size_uniform=e.getUniformLocation(this.draw_program,"screen_size"),this.computation_texture_uniform=e.getUniformLocation(this.draw_program,"computation_texture"),this.gamma_uniform=e.getUniformLocation(this.draw_program,"gamma"),this.color_map_uniform=e.getUniformLocation(this.computation_program,"color_map")}},o.prototype.draw=function(){if(this.context){var t=this.context;t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE),t.clearColor(0,0,0,1),t.useProgram(this.computation_program),t.uniform2f(this.c_screen_size_uniform,this.computation_framebuffer_width,this.computation_framebuffer_height),t.uniform1f(this.p_uniform,this.p),t.uniform1f(this.range_factor_uniform,this.range_factor),t.uniform1f(this.dist_factor_uniform,this.dist_factor),t.bindFramebuffer(t.FRAMEBUFFER,this.computation_framebuffer),t.viewport(0,0,this.computation_framebuffer_width,this.computation_framebuffer_height),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);for(var i=0;i<this.translated_points.length;++i){var e=this.translated_points[i];t.uniform2f(this.xi_uniform,e[0],e[1]),t.uniform1f(this.ui_uniform,e[2]),t.bindBuffer(t.ARRAY_BUFFER,this.square_vertices_buffer),t.vertexAttribPointer(this.position_attribute,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLE_STRIP,0,4)}t.bindFramebuffer(t.FRAMEBUFFER,null),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.useProgram(this.draw_program),t.uniform1i(this.color_map_uniform,1),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.color_map_texture),t.uniform1i(this.computation_texture_uniform,1),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.computation_texture),t.uniform1f(this.gamma_uniform,this.gamma),t.uniform2f(this.d_screen_size_uniform,this.canvas.width,this.canvas.height),t.viewport(0,0,this.canvas.width,this.canvas.height),t.bindBuffer(t.ARRAY_BUFFER,this.square_vertices_buffer),t.vertexAttribPointer(this.position_attribute,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.show_points?this.draw_points():this.hide_points()}},o.prototype.hide_points=function(){for(var t=document.getElementsByClassName("tmg-point-"+this.instance);t[0];)t[0].parentNode.removeChild(t[0])},o.prototype.draw_points=function(){this.hide_points();for(var t=0;t<this.points.length;++t){var i=this.points[t],e=document.createElement("p");e.style.position="absolute",e.style.zIndex=""+(Number(this.canvas.style.zIndex)+1),e.className="tmg-point tmg-point-"+this.instance,e.innerHTML="<span class='tmg-point-value'>"+this.point_text(i[2])+"</span><span class='tmg-point-unit'>"+this.unit+"</span>",this.canvas.parentNode.insertBefore(e,this.canvas.nextSibling),e.style.left=i[0]-e.clientWidth/2+"px",e.style.top=i[1]-e.clientHeight/2+"px"}},o.prototype.resize=function(t,i){this.canvas.height=i,this.canvas.width=t,this.canvas.style.height=this.canvas.height+"px",this.canvas.style.width=this.canvas.width+"px",this.init_buffers()},o.prototype.destroy=function(){this.own_canvas&&this.canvas.parentNode.removeChild(this.canvas),this.hide_points()},o.prototype.generate_color_map_texture=function(t){if(this.context){for(var i=this.context,e=[],r=t[0][0],o=t[t.length-1][0],s=0;s<128;++s){var f=n(a(r+(o-r)*s/128,t));e.push(f.r),e.push(f.g),e.push(f.b),e.push(1)}var h=i.createTexture();i.bindTexture(i.TEXTURE_2D,h);var c=new Uint8Array(e),u=e.length/4;return i.texImage2D(i.TEXTURE_2D,0,i.RGBA,u,1,0,i.RGBA,i.UNSIGNED_BYTE,c),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),h}},o});